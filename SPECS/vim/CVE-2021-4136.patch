From 605ec91e5a7330d61be313637e495fa02a6dc264 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Sat, 18 Dec 2021 16:54:31 +0000
Subject: [PATCH] patch 8.2.3847: illegal memory access when using a lambda
 with an error

Problem:    Illegal memory access when using a lambda with an error.
Solution:   Avoid skipping over the NUL after a string.

Backported to vim 8.2.3668

Signed-off-by: Henry Beberman <henry.beberman@microsoft.com>
---
 src/eval.c                  | 7 +++++--
 src/testdir/test_lambda.vim | 2 ++
 2 files changed, 6 insertions(+), 2 deletions(-)

diff -Naur a/src/eval.c b/src/eval.c
--- a/src/eval.c	2021-11-24 12:28:31.000000000 -0800
+++ b/src/eval.c	2021-12-28 11:47:30.087348603 -0800
@@ -3850,12 +3850,15 @@
 	++*arg;
 	ret = eval1(arg, rettv, evalarg);
 	*arg = skipwhite_and_linebreak(*arg, evalarg);
-	if (**arg != ')')
+	if (**arg == ')')
+	{
+	    ++*arg;
+	}
+	else
 	{
 	    emsg(_(e_missing_close));
 	    ret = FAIL;
 	}
-	++*arg;
     }
     if (ret != OK)
 	return FAIL;
diff -Naur a/src/testdir/test_lambda.vim b/src/testdir/test_lambda.vim
--- a/src/testdir/test_lambda.vim	2021-11-24 12:28:31.000000000 -0800
+++ b/src/testdir/test_lambda.vim	2021-12-28 11:48:19.397209114 -0800
@@ -64,6 +64,8 @@
   call assert_fails('echo {a, a -> a + a}(1, 2)', 'E853:')
   call assert_fails('echo {a, b -> a + b)}(1, 2)', 'E451:')
   echo assert_fails('echo 10->{a -> a + 2}', 'E107:')
+
+  call assert_fails('eval 0->(', "E110: Missing ')'")
 endfunc
 
 func Test_not_lamda()
