From d91a8fb06a65491e4e6f75cade82ae8c9c043487 Mon Sep 17 00:00:00 2001
From: Pawel Winogrodzki <pawelwi@microsoft.com>
Date: Tue, 7 Jun 2022 16:40:53 -0700
Subject: [PATCH] Applying patch for CVE-2021-44647 from
 http://lua-users.org/lists/lua-l/2021-11/msg00206.html.

---
 src/lstate.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/src/lstate.c b/src/lstate.c
index c5e3b43..38da773 100644
--- a/src/lstate.c
+++ b/src/lstate.c
@@ -271,6 +271,7 @@ static void close_state (lua_State *L) {
   if (!completestate(g))  /* closing a partially built state? */
     luaC_freeallobjects(L);  /* jucst collect its objects */
   else {  /* closing a fully built state */
+    L->ci = &L->base_ci;  /* unwind CallInfo list */
     luaD_closeprotected(L, 1, LUA_OK);  /* close all upvalues */
     luaC_freeallobjects(L);  /* collect all objects */
     luai_userstateclose(L);
-- 
2.34.1

